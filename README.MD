# 특강 신청 서비스

특정 요일의 특강을 신청하고, 선착순으로 먼저 신청한 사용자만 성공 시키는 서비스를 구현해보고자 합니다. 구현해야할 api는 아래와 같습니다.

- 특강 신청 API
- 특강 신청 여부 조회 API

이 서비스를 구현하면서 고려해야할 부분은 다음과 같습니다.

- 기능별 명세화 및 제약 사항을 보여줄 단위 테스트를 하나 이상 작성해야합니다.
- 다수의 인스턴스로 애플리케이션이 동작하더라도 기능에 문제가 없어야 합니다.
- 동시성 이슈를 고려하여 구현합니다.

## 요구사항 분석

- **단위 테스트 :** 비즈니스 룰에 맞게 기능을 구현과 동시에 그 기능의 특징을 명세화할 수 있는 테스트 코드 작성을 병행하도록 합니다.
- **다수의 인스턴스 :** was는 stateless하게 구성. db의 경우 공유 자원 저장소로서 하나 인스턴스만 구성합니다.
    - stateless 하게 구성한다는 것은 was를 단순히 요청이 오면 응답을 보내는 역할만 수행하게 구성한다는 것입니다.
    - 상태 유지와 같은 역할은 DB에게 위임하는데, 다수의 was 인스턴스에서 다뤄지는 데이터의 정합성을 유지하는 가장 단순한 방법은 단 하나의 DB를 구성하는 것입니다.
- **동시성 이슈 :** 공유 자원 활용시, 연산의 단일화
    - DB의 경우, 트랜잭션 활용합니다. INSERT 작업은 InnoDB 스토리지 엔진에 한정하여 배타락(exclusive locks)으로 관리하여 경합을 방지합니다.
    - Spring Boot를 활용할 경우, was의 스레드풀을 활용하여, 기본적으로 요청당 단일 스레드 사용합니다.
        - 따라서, 단일 사용자에 한해서는 연산이 누락되는 경우는 없습니다.
        - 그러나 연산이 누락되지 않는 특성이 오히려 비즈니스 룰을 위반할수도 있다는 점은 인지해야 합니다.

## API 스펙 분석

각 api를 통해 제공 받는 서비스를 분석하여 비즈니스 룰을 최대한 맞춰보고자 합니다.

### 1. 특강 신청 API

1. 특정 userId 로 선착순으로 제공되는 특강을 신청하는 api 입니다.
    - 사용자는 userId로 식별합니다.
    - 사용자는 특강을 신청하는 '요청'을 수행할 수 있으며, 특강 서비스는 신청한 사용자들을 식별하여 시간별로 나열하는 기능이 필요합니다.
    - 따라서, 사용자 테이블이 필요합니다.
    - 따라서, 특강 테이블이 필요합니다.
    - 여러 사용자가 하나의 특강을 신청하는 구조이기 때문에, '수강 신청' 테이블을 통해 중간 테이블을 구성해주어야
2. 동일한 신청자는 한 번의 수강 신청만 성공할 수 있습니다.
    - 원칙적으로는 한 번만 수강 신청이 가능하게 합니다.
    - 하지만, 동시에 두 번 이상의 수강 신청이 발생할 경우를 정의하고 이를 대비할 방법을 찾아야 합니다.
      - 여러가지가 있겠지만, 일반적으로는 사용자가 실수로 수강 신청 버튼을 여러번 누른 경우가 있겠습니다.
      - 또 하나는 악성 봇을 활용한 경우 입니다.
      - 두 경우의 공통점은 동일한 사용자가 동일한 api를 여러번 호출한 것입니다.
      - 멱등성을 보장하는 방법이 필요하며, 이를 위해서 api 요청을 구분하는 '멱등키'를 활용하여, 최초의 요청만 수강 신청을 수행하고 그 이후로는 수강 신청 결과를 리턴하도록 합니다.
    - 따라서, 수강 신청 테이블에 멱등키를 추가하여, 중복 수강 신청을 방지합니다.
    - 멱등키 구성 방법은 간단하게 사용자 식별키와 특강 식별키를 조합하여 생성합니다.
3. 특강은 4월 20일 토요일 1시 에 열리며, 선착순 30명만 신청 가능합니다.
   - 특강 테이블에 특강 정보를 추가합니다.
   - 특강 테이블에 특강 신청 인원을 관리합니다.
   - 특강 신청 인원이 30명을 초과할 경우, 수강 신청을 거부합니다.(400 Bad Request)
   - 특강 신청 인원이 30명을 초과하지 않을 경우, 수강 신청을 성공합니다.(200 OK)

### 2. 특강 신청 여부 조회 API

1. 특정 userId 로 특강 신청 완료 여부를 조회하는 API 를 작성합니다.
   - 사용자는 userId로 식별합니다.
   - 특강 서비스는 특정 userId가 특강 신청을 완료했는지 여부를 반환합니다.
2. 특강 신청에 성공한 사용자는 성공했음을, 특강 등록자 명단에 없는 사용자는 실패했음을 반환합니다.
   - 수강 신청 테이블을 조회하여, 해당 userId가 선착순에 해당하는 순번으로 등록되어 있는지 확인합니다.
   - 선착순에 해당하는 순번으로 등록되어 있을 경우, 성공을 반환합니다.
   - 선착순에 해당하는 순번으로 등록되어 있지 않을 경우, 실패를 반환합니다.

## ERD

```SQL
CREATE TABLE IF NOT EXISTS `user` (
  id BIGINT AUTO_INCREMENT PRIMARY KEY
);

CREATE TABLE IF NOT EXISTS lesson (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    maximum BIGINT NOT NULL,
    enroll_count BIGINT NOT NULL,
    due_date DATE NOT NULL
);

CREATE TABLE IF NOT EXISTS enrollment (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    lesson_id BIGINT NOT NULL,
    is_attended BOOLEAN NOT NULL,
    FOREIGN KEY (user_id) REFERENCES `user`(id),
    FOREIGN KEY (lesson_id) REFERENCES lesson(id)
);
```

